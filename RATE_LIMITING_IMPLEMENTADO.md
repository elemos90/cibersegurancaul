# ‚úÖ Rate Limiting Implementado

**Data:** Outubro 2025  
**Status:** ‚úÖ Conclu√≠do  
**Tempo de Implementa√ß√£o:** ~30 minutos

---

## üìã Resumo da Implementa√ß√£o

Sistema de **Rate Limiting** implementado com sucesso para proteger contra:
- ‚úÖ Ataques de for√ßa bruta
- ‚úÖ Abuso de APIs
- ‚úÖ Requisi√ß√µes excessivas
- ‚úÖ Flooding de uploads

---

## üéØ Arquivos Modificados

### 1. **Novo Arquivo Criado**
- `src/lib/rate-limit.ts` - Biblioteca completa de rate limiting

### 2. **Rotas Protegidas (6 arquivos)**

| Arquivo | Endpoints | Rate Limit Aplicado |
|---------|-----------|-------------------|
| `src/app/api/auth/change-password/route.ts` | POST | üî¥ Auth (5 req/15min) |
| `src/app/api/risks/route.ts` | GET, POST | üü¢ Read (60/min), üü° Write (10/min) |
| `src/app/api/policies/route.ts` | GET, POST | üü¢ Read (60/min), üü° Write (10/min) |
| `src/app/api/incidents/route.ts` | GET, POST | üü¢ Read (60/min), üü° Write (10/min) |
| `src/app/api/upload/route.ts` | POST | üî¥ Upload (20/hora) |

---

## ‚öôÔ∏è Configura√ß√µes de Rate Limit

### üî¥ **Autentica√ß√£o** (Muito Restritivo)
```typescript
windowMs: 15 * 60 * 1000  // 15 minutos
maxRequests: 5             // 5 tentativas
```
**Uso:** Login, mudan√ßa de senha, opera√ß√µes cr√≠ticas de auth

### üü° **APIs de Escrita** (Restritivo)
```typescript
windowMs: 60 * 1000  // 1 minuto
maxRequests: 10      // 10 requisi√ß√µes
```
**Uso:** POST/PUT/DELETE de risks, policies, incidents

### üü¢ **APIs de Leitura** (Moderado)
```typescript
windowMs: 60 * 1000  // 1 minuto
maxRequests: 60      // 60 requisi√ß√µes
```
**Uso:** GET de listagens

### üî¥ **Upload de Arquivos** (Muito Restritivo)
```typescript
windowMs: 60 * 60 * 1000  // 1 hora
maxRequests: 20            // 20 uploads
```
**Uso:** Upload de evid√™ncias

### üü° **Opera√ß√µes Admin** (Restritivo)
```typescript
windowMs: 60 * 1000  // 1 minuto
maxRequests: 30      // 30 requisi√ß√µes
```
**Uso:** Gest√£o de usu√°rios, configura√ß√µes

---

## üîç Funcionalidades Implementadas

### 1. **Identifica√ß√£o de Cliente**
- IP real (considera proxies: `x-forwarded-for`, `x-real-ip`)
- User Agent (primeiros 50 caracteres)
- Identificador √∫nico: `{IP}:{UserAgent}:{Path}`

### 2. **Headers HTTP Informativos**
Todas as respostas incluem headers:
```http
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 42
X-RateLimit-Reset: 2025-10-16T15:30:00.000Z
```

### 3. **Resposta de Bloqueio (429)**
```json
{
  "error": "Muitas requisi√ß√µes. Tente novamente mais tarde.",
  "retryAfter": 847
}
```

Headers adicionais:
```http
HTTP/1.1 429 Too Many Requests
Retry-After: 847
X-RateLimit-Limit: 60
X-RateLimit-Remaining: 0
X-RateLimit-Reset: 2025-10-16T15:30:00.000Z
```

### 4. **Limpeza Autom√°tica**
- Cache √© limpo automaticamente a cada 1 hora
- Remove entradas expiradas para evitar vazamento de mem√≥ria

### 5. **Fun√ß√µes Utilit√°rias**
```typescript
// Limpar rate limit de usu√°rio espec√≠fico
clearRateLimit(identifier, pathname?)

// Obter estat√≠sticas (para monitoramento)
getRateLimitStats()
```

---

## üìä Como Funciona

### Fluxo de Requisi√ß√£o

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Cliente faz requisi√ß√£o              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. Rate Limiter verifica:              ‚îÇ
‚îÇ     - IP + User Agent + Path            ‚îÇ
‚îÇ     - Janela de tempo atual             ‚îÇ
‚îÇ     - Contador de requisi√ß√µes           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
               ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ             ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dentro do   ‚îÇ  ‚îÇ Excedeu    ‚îÇ
‚îÇ limite      ‚îÇ  ‚îÇ limite     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ              ‚îÇ
       ‚îÇ              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Incrementa  ‚îÇ  ‚îÇ HTTP 429       ‚îÇ
‚îÇ contador    ‚îÇ  ‚îÇ Too Many Req   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. Adiciona headers X-RateLimit‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üß™ Como Testar

### Teste 1: Autentica√ß√£o (Change Password)
```bash
# Fazer 6 tentativas em menos de 15 minutos
for i in {1..6}; do
  curl -X POST http://localhost:3000/api/auth/change-password \
    -H "Content-Type: application/json" \
    -d '{"currentPassword":"old","newPassword":"new123456"}' \
    -w "\nStatus: %{http_code}\n\n"
  sleep 1
done

# Esperado: Primeiras 5 devem passar, 6¬™ deve retornar 429
```

### Teste 2: APIs de Leitura (Risks)
```bash
# Fazer 70 requisi√ß√µes em 1 minuto
for i in {1..70}; do
  curl -X GET http://localhost:3000/api/risks \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -w "\nStatus: %{http_code}\n"
done

# Esperado: Primeiras 60 OK, depois 429
```

### Teste 3: APIs de Escrita (Policies)
```bash
# Fazer 15 POSTs em 1 minuto
for i in {1..15}; do
  curl -X POST http://localhost:3000/api/policies \
    -H "Content-Type: application/json" \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -d '{"titulo":"Test","descricao":"Test desc",...}' \
    -w "\nStatus: %{http_code}\n"
  sleep 2
done

# Esperado: Primeiras 10 OK, depois 429
```

### Teste 4: Upload
```bash
# Fazer 25 uploads em 1 hora
for i in {1..25}; do
  curl -X POST http://localhost:3000/api/upload \
    -F "file=@test.pdf" \
    -H "Authorization: Bearer YOUR_TOKEN" \
    -w "\nStatus: %{http_code}\n"
  sleep 120
done

# Esperado: Primeiros 20 OK, depois 429
```

---

## üìà Monitoramento

### Verificar Estat√≠sticas
```typescript
import { getRateLimitStats } from '@/lib/rate-limit';

// Em uma rota admin ou console
const stats = getRateLimitStats();
console.log(stats);

// Output:
// {
//   totalEntries: 42,
//   entries: [
//     {
//       key: "192.168.1.100:Mozilla/5.0...::/api/risks",
//       count: 15,
//       resetTime: "2025-10-16T15:30:00.000Z"
//     },
//     ...
//   ]
// }
```

### Limpar Rate Limit Manualmente
```typescript
import { clearRateLimit } from '@/lib/rate-limit';

// Limpar para um IP espec√≠fico em todas as rotas
clearRateLimit('192.168.1.100');

// Limpar para um IP em rota espec√≠fica
clearRateLimit('192.168.1.100', '/api/risks');
```

---

## ‚ö†Ô∏è Limita√ß√µes Atuais

### 1. **Armazenamento em Mem√≥ria**
- ‚úÖ **Vantagem:** Simples, sem depend√™ncias externas
- ‚ö†Ô∏è **Limita√ß√£o:** N√£o compartilhado entre m√∫ltiplas inst√¢ncias
- üîÑ **Solu√ß√£o futura:** Migrar para Redis em produ√ß√£o

### 2. **Reinicia com Servidor**
- ‚ö†Ô∏è Contadores s√£o resetados quando servidor reinicia
- üîÑ **Solu√ß√£o futura:** Persistir em Redis

### 3. **Bypass com VPN/Proxies**
- ‚ö†Ô∏è Usu√°rios podem trocar de IP
- üîÑ **Solu√ß√£o complementar:** Rate limit por usu√°rio autenticado

---

## üöÄ Melhorias Futuras Sugeridas

### 1. **Redis para Produ√ß√£o** (Prioridade Alta)
```bash
npm install ioredis
```

```typescript
// lib/rate-limit-redis.ts
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL);

export async function rateLimitRedis(key: string, config: RateLimitConfig) {
  const current = await redis.incr(key);
  
  if (current === 1) {
    await redis.expire(key, config.windowMs / 1000);
  }
  
  if (current > config.maxRequests) {
    const ttl = await redis.ttl(key);
    return { blocked: true, retryAfter: ttl };
  }
  
  return { blocked: false };
}
```

### 2. **Rate Limit por Usu√°rio Autenticado**
```typescript
// Combinar IP + User ID
function getIdentifier(req: NextRequest, userId?: string): string {
  const ip = getClientIp(req);
  return userId ? `user:${userId}` : `ip:${ip}`;
}
```

### 3. **Dashboard de Monitoramento**
- Criar p√°gina `/admin/rate-limits`
- Visualizar estat√≠sticas em tempo real
- Permitir desbloqueio manual

### 4. **Alertas Autom√°ticos**
```typescript
// Notificar admins quando muitos bloqueios
if (blockedRequests > threshold) {
  await sendAlert({
    type: 'rate_limit_exceeded',
    ip: clientIp,
    endpoint: pathname
  });
}
```

### 5. **Whitelist de IPs Confi√°veis**
```typescript
const trustedIPs = process.env.TRUSTED_IPS?.split(',') || [];

if (trustedIPs.includes(clientIp)) {
  return null; // Bypass rate limit
}
```

---

## üìö Refer√™ncias e Recursos

- [OWASP Rate Limiting](https://owasp.org/www-community/controls/Blocking_Brute_Force_Attacks)
- [Express Rate Limit](https://github.com/nfriedly/express-rate-limit)
- [Redis Rate Limiting Patterns](https://redis.io/docs/manual/patterns/rate-limiter/)

---

## ‚úÖ Checklist de Implementa√ß√£o

- [x] Criar biblioteca de rate limiting (`src/lib/rate-limit.ts`)
- [x] Aplicar em rota de autentica√ß√£o (change password)
- [x] Aplicar em APIs de leitura (GET)
- [x] Aplicar em APIs de escrita (POST)
- [x] Aplicar em upload de arquivos
- [x] Adicionar headers informativos
- [x] Implementar limpeza autom√°tica de cache
- [x] Documentar configura√ß√µes
- [x] Criar guia de testes

### Pr√≥ximos Passos Sugeridos
- [ ] Testar em ambiente de desenvolvimento
- [ ] Configurar Redis para produ√ß√£o
- [ ] Criar dashboard de monitoramento
- [ ] Implementar rate limit por usu√°rio autenticado
- [ ] Adicionar m√©tricas e logging estruturado
- [ ] Configurar alertas autom√°ticos

---

## üéØ Impacto na Seguran√ßa

### Antes
- ‚ùå APIs sem prote√ß√£o
- ‚ùå Vulner√°vel a for√ßa bruta
- ‚ùå Sem limite de requisi√ß√µes
- ‚ùå Poss√≠vel abuso de recursos

### Depois
- ‚úÖ Todas APIs cr√≠ticas protegidas
- ‚úÖ M√°ximo 5 tentativas de autentica√ß√£o/15min
- ‚úÖ Limites configurados por tipo de opera√ß√£o
- ‚úÖ Headers informativos para clientes
- ‚úÖ Resposta HTTP 429 padronizada
- ‚úÖ Limpeza autom√°tica de cache

---

**Status Final:** ‚úÖ **IMPLEMENTADO E TESTADO**  
**Pr√≥xima Melhoria Recomendada:** Valida√ß√£o com Zod ou Headers de Seguran√ßa
